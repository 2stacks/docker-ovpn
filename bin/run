#!/bin/sh
set -e

[ -d /dev/net ] ||
    mkdir -p /dev/net
[ -c /dev/net/tun ] ||
    mknod /dev/net/tun c 10 200

cd /etc/openvpn

cat >tcp443.conf <<EOF
port 443
proto tcp-server
dev tun443
ca ca.crt
cert site.crt
key site.key
dh site.dh
server 10.43.95.0 255.255.255.0
push "persist-key"
push "persist-tun"
push "redirect-gateway def1"
push "dhcp-option DNS $DNS_HOST1"
push "dhcp-option DNS $DNS_HOST2"
duplicate-cn
keepalive 10 30
tls-auth ta.key 0
auth SHA256
cipher AES-128-CBC
tls-cipher TLS-ECDHE-RSA-WITH-AES-128-CBC-SHA256:TLS-ECDHE-ECDSA-WITH-AES-128-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256:LS-ECDHE-RSA-WITH-AES-128-GCM-SHA256:TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256
comp-lzo
user nobody
group nogroup
persist-key
persist-tun
status openvpn-status-443.log
plugin /usr/lib/openvpn/radiusplugin.so /etc/openvpn/radius443.conf
username-as-common-name
client-cert-not-required
verify-client-cert none
log /dev/null
suppress-timestamps
verb 0
mute 10
EOF

cat >radius443.conf <<EOF
NAS-Identifier=OpenVpn
Service-Type=5
Framed-Protocol=1
NAS-Port-Type=5
NAS-IP-Address=ovpn
OpenVPNConfig=/etc/openvpn/tcp443.conf
subnet=255.255.255.0
overwriteccfiles=true
nonfatalaccounting=true
server
{
    acctport=1813
    authport=1812
    name=$RADIUS_HOST
    retry=3
    wait=3
    sharedsecret=$RADIUS_KEY
}
EOF

cat >udp1194.conf <<EOF
port 1194
proto udp
dev tun1194
ca ca.crt
key site.key
cert site.crt
dh site.dh
server 10.43.94.0 255.255.255.0
push "persist-key"
push "persist-tun"
push "redirect-gateway def1"
push "dhcp-option DNS $DNS_HOST1"
push "dhcp-option DNS $DNS_HOST2"
duplicate-cn
keepalive 10 30
tls-auth ta.key 0
auth SHA256
cipher AES-128-CBC
tls-cipher TLS-ECDHE-RSA-WITH-AES-128-CBC-SHA256:TLS-ECDHE-ECDSA-WITH-AES-128-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256:LS-ECDHE-RSA-WITH-AES-128-GCM-SHA256:TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256
comp-lzo
fast-io
user nobody
group nogroup
persist-key
persist-tun
status openvpn-status-1194.log
plugin /usr/lib/openvpn/radiusplugin.so /etc/openvpn/radius1194.conf
username-as-common-name
client-cert-not-required
verify-client-cert none
log /dev/null
suppress-timestamps
verb 0
mute 10
explicit-exit-notify 1
EOF

cat >radius1194.conf <<EOF
NAS-Identifier=OpenVpn
Service-Type=5
Framed-Protocol=1
NAS-Port-Type=5
NAS-IP-Address=ovpn
OpenVPNConfig=/etc/openvpn/udp1194.conf
subnet=255.255.255.0
overwriteccfiles=true
nonfatalaccounting=true
server
{
    acctport=1813
    authport=1812
    name=$RADIUS_HOST
    retry=3
    wait=3
    sharedsecret=$RADIUS_KEY
}
EOF

iptables -t nat -A POSTROUTING -s 10.43.94.0/23 -o eth0 -j MASQUERADE

#touch tcp443.log udp1194.log
#while true ; do openvpn tcp443.conf ; done >> tcp443.log &
#while true ; do openvpn udp1194.conf ; done >> udp1194.log &
#tail -f *.log
while true ; do openvpn tcp443.conf ; done &
while true ; do openvpn udp1194.conf ; done
